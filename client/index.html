<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPSU Student Portal 2026 - Enhanced</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        brand: '#EE3F36', 
                        brandDark: '#b91c1c',
                        dark: '#0f172a', 
                        surface: '#ffffff' 
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: {
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'fade-in': 'fadeIn 0.4s ease-out forwards'
                    },
                    keyframes: {
                        slideIn: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(0)' } },
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #f1f5f9; -webkit-font-smoothing: antialiased; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        
        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-left: 4px solid #EE3F36; transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); display: flex; align-items: center; gap: 12px; min-width: 300px; }
        .toast.show { transform: translateX(0); }
        .toast-success { border-color: #10b981; }
        .toast-error { border-color: #ef4444; }

        .loader-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #EE3F36; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col">

    <div id="toast-container"></div>

    <div id="app" class="flex h-full w-full relative">

        <aside id="sidebar" class="hidden md:flex flex-col w-64 bg-dark text-slate-300 h-full fixed md:relative z-40 sidebar-transition -translate-x-full md:translate-x-0">
            <div class="h-16 flex items-center px-6 border-b border-slate-700 bg-slate-900">
                <i class="fa-solid fa-graduation-cap text-brand text-2xl mr-3"></i>
                <span class="text-white font-bold text-lg tracking-wide">PPSU Portal</span>
                <button class="md:hidden ml-auto text-white" onclick="toggleSidebar()"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="p-6 border-b border-slate-700/50 bg-slate-800/50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-brand to-orange-500 flex items-center justify-center text-white font-bold shadow-lg" id="sideInitials">U</div>
                    <div class="overflow-hidden">
                        <h4 class="text-sm font-bold text-white truncate" id="sideName">Guest</h4>
                        <p class="text-xs text-slate-400" id="sideId">ID: Pending</p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 py-4 px-3 space-y-1 overflow-y-auto">
                <button onclick="nav('overview')" id="btn-overview" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-white/5 hover:text-white transition group active-nav">
                    <i class="fa-solid fa-grid-2 text-slate-400 group-hover:text-brand transition"></i> Overview
                </button>
                <button onclick="nav('application')" id="btn-application" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-white/5 hover:text-white transition group">
                    <i class="fa-solid fa-file-pen text-slate-400 group-hover:text-brand transition"></i> Application
                </button>
                <button onclick="nav('documents')" id="btn-documents" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-white/5 hover:text-white transition group">
                    <i class="fa-solid fa-folder-open text-slate-400 group-hover:text-brand transition"></i> Documents
                </button>
                <button onclick="nav('hostel')" id="btn-hostel" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-white/5 hover:text-white transition group">
                    <i class="fa-solid fa-bed text-slate-400 group-hover:text-brand transition"></i> Hostel
                </button>
                <button onclick="nav('fees')" id="btn-fees" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-white/5 hover:text-white transition group">
                    <i class="fa-solid fa-receipt text-slate-400 group-hover:text-brand transition"></i> Fee & Receipts
                </button>
            </nav>

            <div class="p-4 border-t border-slate-700">
                <button onclick="logout()" class="w-full py-2 px-4 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-power-off"></i> Logout
                </button>
            </div>
        </aside>

        <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden backdrop-blur-sm"></div>

        <main class="flex-1 flex flex-col h-full overflow-hidden bg-slate-50 relative">
            
            <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-8 shadow-sm z-20">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="md:hidden text-slate-500 hover:text-brand"><i class="fa-solid fa-bars text-xl"></i></button>
                    <h2 id="pageTitle" class="text-xl font-bold text-slate-800">Dashboard</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div id="notificationBtn" class="relative cursor-pointer text-slate-400 hover:text-brand transition">
                        <i class="fa-solid fa-bell text-xl"></i>
                        <span class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                    </div>
                    <div class="hidden md:block text-right">
                        <p class="text-xs text-slate-400 font-medium">Academic Year</p>
                        <p class="text-sm font-bold text-brand">2026-27</p>
                    </div>
                </div>
            </header>

            <div id="contentArea" class="flex-1 overflow-y-auto p-4 md:p-8 relative">
                
                <div id="publicView" class="max-w-6xl mx-auto space-y-12">
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col md:flex-row min-h-[500px] animate-fade-in">
                        <div class="md:w-1/2 p-8 md:p-12 flex flex-col justify-center bg-white relative z-10">
                            <img src="https://www.ppsu.ac.in/img/PPSUNAACA+Logo.png" class="h-16 w-auto mb-8 self-start" alt="PPSU">
                            <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-4 leading-tight">Future Begins <br><span class="text-brand">Here & Now.</span></h1>
                            <p class="text-slate-500 text-lg mb-8 leading-relaxed">Admissions open for 2026. Join a legacy of excellence in Engineering, Management, and Sciences.</p>
                            
                            <div class="bg-slate-100 p-1 rounded-lg inline-flex mb-6 w-full max-w-sm">
                                <button onclick="switchAuth('login')" id="tab-login" class="w-1/2 py-2 rounded-md text-sm font-bold shadow-sm bg-white text-slate-900 transition-all">Login</button>
                                <button onclick="switchAuth('register')" id="tab-register" class="w-1/2 py-2 rounded-md text-sm font-bold text-slate-500 hover:text-slate-700 transition-all">New Admission</button>
                            </div>

                            <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-4 max-w-sm">
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase">Mobile Number</label>
                                    <div class="relative">
                                        <i class="fa-solid fa-mobile-screen absolute left-3 top-3.5 text-slate-400"></i>
                                        <input type="tel" id="loginMobile" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:border-brand transition" placeholder="9876543210" required>
                                    </div>
                                </div>
                                <button type="submit" class="w-full py-3 bg-slate-900 text-white font-bold rounded-lg hover:bg-slate-800 transition shadow-lg shadow-slate-900/20">Access Dashboard <i class="fa-solid fa-arrow-right ml-2"></i></button>
                            </form>

                            <form id="registerForm" onsubmit="handleRegister(event)" class="space-y-4 max-w-sm hidden">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase">Full Name</label>
                                        <input type="text" id="regName" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:border-brand" required>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase">Mobile</label>
                                        <input type="tel" id="regMobile" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:border-brand" required>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase">Select Course</label>
                                    <select id="regCourse" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:border-brand">
                                        <option>B.Tech Computer Engineering</option>
                                        <option>B.Tech Civil Engineering</option>
                                        <option>BBA (Marketing)</option>
                                        <option>MBA (Finance)</option>
                                    </select>
                                </div>
                                <button type="submit" class="w-full py-3 bg-brand text-white font-bold rounded-lg hover:bg-brandDark transition shadow-lg shadow-brand/20">Start Application</button>
                            </form>
                        </div>
                        
                        <div class="md:w-1/2 bg-slate-900 relative overflow-hidden hidden md:block">
                            <img src="https://images.unsplash.com/photo-1523050854058-8df90110c9f1?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80" class="absolute inset-0 w-full h-full object-cover opacity-60">
                            <div class="absolute bottom-0 left-0 p-12 text-white z-10">
                                <div class="w-16 h-1 bg-brand mb-4"></div>
                                <h3 class="text-2xl font-bold">100 Acres of Innovation</h3>
                                <p class="text-slate-300 mt-2">Experience a campus designed for holistic growth.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dashboardViews" class="hidden max-w-6xl mx-auto pb-10">
                    
                    <div id="view-overview" class="view-section animate-fade-in">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-slate-800" id="greetUser">Hello, Student!</h1>
                            <p class="text-slate-500 mt-1">Here is what's happening with your admission today.</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa-solid fa-chart-line text-6xl text-brand"></i></div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Application Progress</p>
                                <div class="flex items-end gap-2 mb-2">
                                    <h2 class="text-4xl font-bold text-slate-800" id="progressPercent">0%</h2>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-2">
                                    <div id="progressBar" class="bg-brand h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                                </div>
                                <p class="text-xs text-brand mt-2 font-medium" id="progressText">Complete profile to proceed</p>
                            </div>

                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Current Status</p>
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse" id="statusDot"></div>
                                    <h2 class="text-2xl font-bold text-slate-800" id="statusText">Pending</h2>
                                </div>
                                <p class="text-sm text-slate-500">Application Fee: <span id="feeStatusText" class="font-bold text-slate-800">Unpaid</span></p>
                            </div>

                            <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-xl shadow-lg text-white flex flex-col justify-between">
                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Quick Action</p>
                                    <h3 class="text-xl font-bold">Upload Documents</h3>
                                </div>
                                <button onclick="nav('documents')" class="self-start mt-4 bg-white/10 hover:bg-white/20 border border-white/20 text-white py-2 px-4 rounded-lg text-sm transition">Go to Uploads</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                                <h3 class="font-bold text-lg mb-4">Announcements</h3>
                                <div class="space-y-4">
                                    <div class="flex gap-4 items-start">
                                        <div class="bg-blue-50 text-blue-600 p-2 rounded-lg text-xs font-bold text-center w-12 flex-shrink-0">JAN<br><span class="text-lg">15</span></div>
                                        <div>
                                            <h4 class="font-bold text-sm text-slate-800">Entrance Exam Schedule</h4>
                                            <p class="text-xs text-slate-500 mt-1">The hall tickets will be available for download starting next week.</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-4 items-start">
                                        <div class="bg-green-50 text-green-600 p-2 rounded-lg text-xs font-bold text-center w-12 flex-shrink-0">FEB<br><span class="text-lg">01</span></div>
                                        <div>
                                            <h4 class="font-bold text-sm text-slate-800">Document Verification</h4>
                                            <p class="text-xs text-slate-500 mt-1">Online verification process begins.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="view-application" class="view-section hidden animate-fade-in">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="border-b border-slate-100 p-6 flex justify-between items-center">
                                <h3 class="font-bold text-lg">Application Details</h3>
                                <span id="appFormStatusBadge" class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold">Draft</span>
                            </div>
                            <div class="p-6 md:p-8">
                                <form id="mainAppForm" onsubmit="saveApplication(event)">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Full Name</label><input type="text" id="app_name" class="w-full border rounded-lg px-4 py-2 bg-slate-50" readonly></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Course</label><input type="text" id="app_course" class="w-full border rounded-lg px-4 py-2 bg-slate-50" readonly></div>
                                        <div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Address</label><textarea id="app_address" rows="2" class="w-full border rounded-lg px-4 py-2 focus:border-brand outline-none" placeholder="Enter permanent address"></textarea></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">City</label><input type="text" id="app_city" class="w-full border rounded-lg px-4 py-2 focus:border-brand outline-none"></div>
                                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pincode</label><input type="text" id="app_pincode" class="w-full border rounded-lg px-4 py-2 focus:border-brand outline-none"></div>
                                    </div>
                                    <div class="flex justify-end gap-3">
                                        <button type="button" onclick="downloadApplicationPDF()" class="px-4 py-2 text-brand border border-brand rounded-lg font-bold text-sm hover:bg-red-50 hidden" id="btnDownloadApp">Download PDF</button>
                                        <button type="submit" id="btnSaveApp" class="px-6 py-2 bg-slate-900 text-white rounded-lg font-bold text-sm hover:bg-black">Save & Pay ₹1,200</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div id="view-documents" class="view-section hidden animate-fade-in">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <h3 class="font-bold text-lg mb-2">Document Repository</h3>
                            <p class="text-sm text-slate-500 mb-6">Upload clear copies of your documents. These are saved locally in your browser for this demo.</p>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="border border-dashed border-slate-300 rounded-xl p-4 flex flex-col items-center justify-center min-h-[200px] hover:border-brand transition group bg-slate-50">
                                    <div class="w-full h-32 mb-3 bg-white rounded border border-slate-100 flex items-center justify-center overflow-hidden relative">
                                        <img id="prev_10th" class="w-full h-full object-cover hidden">
                                        <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-300 group-hover:text-brand transition" id="icon_10th"></i>
                                    </div>
                                    <h4 class="font-bold text-sm text-slate-700">10th Marksheet</h4>
                                    <input type="file" id="file_10th" class="hidden" onchange="handleFileUpload('10th', this)">
                                    <button onclick="document.getElementById('file_10th').click()" class="mt-2 text-xs text-brand font-bold hover:underline">Select File</button>
                                </div>

                                <div class="border border-dashed border-slate-300 rounded-xl p-4 flex flex-col items-center justify-center min-h-[200px] hover:border-brand transition group bg-slate-50">
                                    <div class="w-full h-32 mb-3 bg-white rounded border border-slate-100 flex items-center justify-center overflow-hidden relative">
                                        <img id="prev_12th" class="w-full h-full object-cover hidden">
                                        <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-300 group-hover:text-brand transition" id="icon_12th"></i>
                                    </div>
                                    <h4 class="font-bold text-sm text-slate-700">12th Marksheet</h4>
                                    <input type="file" id="file_12th" class="hidden" onchange="handleFileUpload('12th', this)">
                                    <button onclick="document.getElementById('file_12th').click()" class="mt-2 text-xs text-brand font-bold hover:underline">Select File</button>
                                </div>

                                 <div class="border border-dashed border-slate-300 rounded-xl p-4 flex flex-col items-center justify-center min-h-[200px] hover:border-brand transition group bg-slate-50">
                                    <div class="w-full h-32 mb-3 bg-white rounded border border-slate-100 flex items-center justify-center overflow-hidden relative">
                                        <img id="prev_aadhar" class="w-full h-full object-cover hidden">
                                        <i class="fa-solid fa-id-card text-3xl text-slate-300 group-hover:text-brand transition" id="icon_aadhar"></i>
                                    </div>
                                    <h4 class="font-bold text-sm text-slate-700">Aadhaar Card</h4>
                                    <input type="file" id="file_aadhar" class="hidden" onchange="handleFileUpload('aadhar', this)">
                                    <button onclick="document.getElementById('file_aadhar').click()" class="mt-2 text-xs text-brand font-bold hover:underline">Select File</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="view-hostel" class="view-section hidden animate-fade-in">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="font-bold text-lg mb-4">Select Accommodation</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-slate-50 transition">
                                        <input type="radio" name="hostel" value="NONAC" class="w-5 h-5 text-brand" onchange="updateHostelTotal(75000)">
                                        <div class="ml-3">
                                            <span class="block font-bold text-slate-800">Non-AC (4 Sharing)</span>
                                            <span class="block text-xs text-slate-500">₹75,000 / Year</span>
                                        </div>
                                    </label>
                                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-slate-50 transition">
                                        <input type="radio" name="hostel" value="AC3" class="w-5 h-5 text-brand" onchange="updateHostelTotal(110000)">
                                        <div class="ml-3">
                                            <span class="block font-bold text-slate-800">AC (3 Sharing)</span>
                                            <span class="block text-xs text-slate-500">₹1,10,000 / Year</span>
                                        </div>
                                    </label>
                                </div>
                                <div class="mt-6 pt-4 border-t flex justify-between items-center">
                                    <div><p class="text-xs text-slate-500">Total Payable</p><p class="text-xl font-bold text-brand" id="hostelTotal">₹0</p></div>
                                    <button onclick="payHostel()" class="px-6 py-2 bg-slate-900 text-white rounded-lg font-bold text-sm">Book Now</button>
                                </div>
                            </div>
                            <div class="bg-slate-100 rounded-xl p-6 flex flex-col items-center justify-center text-center">
                                <i class="fa-solid fa-hotel text-5xl text-slate-300 mb-4"></i>
                                <h4 class="font-bold text-slate-600">Your Booking Status</h4>
                                <p id="hostelStatusMsg" class="text-sm text-slate-500 mt-2">No room allocated yet.</p>
                            </div>
                        </div>
                    </div>

                     <div id="view-fees" class="view-section hidden animate-fade-in">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 border-b">
                                    <tr>
                                        <th class="p-4 font-bold text-slate-600">Description</th>
                                        <th class="p-4 font-bold text-slate-600">Date</th>
                                        <th class="p-4 font-bold text-slate-600">Amount</th>
                                        <th class="p-4 font-bold text-slate-600">Status</th>
                                        <th class="p-4 font-bold text-slate-600 text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y" id="feeTableBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script>
        // ================= STATE MANAGEMENT (LOCAL STORAGE) =================
        const DB_KEY = 'PPSU_PORTAL_V1';
        
        let state = {
            user: null, // { name, mobile, course, id }
            application: { status: 'draft', address: '', city: '', pincode: '', paid: false },
            documents: { '10th': null, '12th': null, 'aadhar': null }, // Stores Base64 strings
            hostel: { booked: false, type: '', fee: 0 },
            transactions: [] 
        };

        // Load State on Init
        function init() {
            const saved = localStorage.getItem(DB_KEY);
            if(saved) {
                state = JSON.parse(saved);
                if(state.user) {
                    showDashboard();
                }
            }
            updateGreeting();
        }

        function saveState() {
            localStorage.setItem(DB_KEY, JSON.stringify(state));
            updateUI();
        }

        // ================= AUTHENTICATION =================
        function switchAuth(type) {
            const loginForm = document.getElementById('loginForm');
            const regForm = document.getElementById('registerForm');
            const tabLogin = document.getElementById('tab-login');
            const tabReg = document.getElementById('tab-register');

            if(type === 'login') {
                loginForm.classList.remove('hidden'); regForm.classList.add('hidden');
                tabLogin.className = "w-1/2 py-2 rounded-md text-sm font-bold shadow-sm bg-white text-slate-900 transition-all";
                tabReg.className = "w-1/2 py-2 rounded-md text-sm font-bold text-slate-500 hover:text-slate-700 transition-all";
            } else {
                loginForm.classList.add('hidden'); regForm.classList.remove('hidden');
                tabReg.className = "w-1/2 py-2 rounded-md text-sm font-bold shadow-sm bg-white text-slate-900 transition-all";
                tabLogin.className = "w-1/2 py-2 rounded-md text-sm font-bold text-slate-500 hover:text-slate-700 transition-all";
            }
        }

        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const mobile = document.getElementById('regMobile').value;
            const course = document.getElementById('regCourse').value;

            state.user = {
                name: name,
                mobile: mobile,
                course: course,
                id: 'APP' + Math.floor(1000 + Math.random() * 9000)
            };
            
            showToast('Welcome to PPSU! Registration Successful.', 'success');
            saveState();
            showDashboard();
        }

        function handleLogin(e) {
            e.preventDefault();
            const mobile = document.getElementById('loginMobile').value;
            
            // Simulating Login Check
            if(state.user && state.user.mobile === mobile) {
                showToast('Welcome back!', 'success');
                showDashboard();
            } else if (!state.user) {
                showToast('No account found. Please Register first.', 'error');
            } else {
                 showToast('Invalid Mobile Number.', 'error');
            }
        }

        function logout() {
            // We keep the data in localStorage so they can log back in, 
            // but we clear the session visually
            document.getElementById('publicView').classList.remove('hidden');
            document.getElementById('dashboardViews').classList.add('hidden');
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('flex'); // Fix tailwind class toggle
            showToast('Logged out successfully.', 'success');
        }

        // ================= DASHBOARD UI LOGIC =================
        function showDashboard() {
            document.getElementById('publicView').classList.add('hidden');
            document.getElementById('dashboardViews').classList.remove('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('sidebar').classList.add('flex');
            
            // Set User Data
            document.getElementById('sideName').innerText = state.user.name;
            document.getElementById('sideInitials').innerText = state.user.name.charAt(0);
            document.getElementById('sideId').innerText = state.user.id;
            
            // Pre-fill App Form
            document.getElementById('app_name').value = state.user.name;
            document.getElementById('app_course').value = state.user.course;
            document.getElementById('app_address').value = state.application.address;
            document.getElementById('app_city').value = state.application.city;
            document.getElementById('app_pincode').value = state.application.pincode;

            nav('overview');
            updateUI();
        }

        function nav(viewId) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            // Show selected
            document.getElementById('view-' + viewId).classList.remove('hidden');
            // Update Title
            document.getElementById('pageTitle').innerText = viewId.charAt(0).toUpperCase() + viewId.slice(1);
            
            // Sidebar Active State
            document.querySelectorAll('aside nav button').forEach(btn => {
                btn.classList.remove('bg-white/10', 'text-white');
                btn.classList.add('hover:bg-white/5');
            });
            document.getElementById('btn-'+viewId).classList.add('bg-white/10', 'text-white');
            
            // Mobile: Close sidebar if open
            const sidebar = document.getElementById('sidebar');
            if(!sidebar.classList.contains('-translate-x-full') && window.innerWidth < 768) {
                toggleSidebar();
            }
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sb.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function updateUI() {
            // 1. Progress Bar Logic
            let progress = 0;
            if(state.application.paid) progress += 40;
            if(state.documents['10th']) progress += 20;
            if(state.documents['12th']) progress += 20;
            if(state.hostel.booked) progress += 20;

            document.getElementById('progressPercent').innerText = progress + '%';
            document.getElementById('progressBar').style.width = progress + '%';

            // 2. Status Text
            const statusText = document.getElementById('statusText');
            const statusDot = document.getElementById('statusDot');
            
            if(state.application.paid) {
                statusText.innerText = "Submitted";
                statusText.classList.replace('text-slate-800', 'text-green-600');
                statusDot.classList.replace('bg-yellow-400', 'bg-green-500');
                document.getElementById('feeStatusText').innerText = "Paid";
                document.getElementById('feeStatusText').className = "font-bold text-green-600";
                
                // Form View Update
                document.getElementById('btnSaveApp').innerText = "Application Submitted";
                document.getElementById('btnSaveApp').disabled = true;
                document.getElementById('btnSaveApp').classList.replace('bg-slate-900', 'bg-green-600');
                document.getElementById('appFormStatusBadge').innerText = "Submitted";
                document.getElementById('appFormStatusBadge').className = "px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold";
                document.getElementById('btnDownloadApp').classList.remove('hidden');
            }

            // 3. Documents (Previews)
            ['10th','12th','aadhar'].forEach(key => {
                if(state.documents[key]) {
                    document.getElementById('prev_'+key).src = state.documents[key];
                    document.getElementById('prev_'+key).classList.remove('hidden');
                    document.getElementById('icon_'+key).classList.add('hidden');
                }
            });

            // 4. Hostel
            if(state.hostel.booked) {
                document.getElementById('hostelStatusMsg').innerHTML = `<span class="text-green-600 font-bold">Booked: ${state.hostel.type}</span>`;
            }

            // 5. Fee Table
            const tbody = document.getElementById('feeTableBody');
            tbody.innerHTML = '';
            
            if(state.application.paid) {
                addFeeRow(tbody, 'Application Fee', 'Paid', '1,200');
            }
            if(state.hostel.booked) {
                addFeeRow(tbody, 'Hostel Fee', 'Paid', state.hostel.fee.toLocaleString());
            }
            if(!state.application.paid && !state.hostel.booked) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-400">No transactions yet</td></tr>';
            }
        }

        function addFeeRow(tbody, desc, status, amt) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="p-4">${desc}</td>
                <td class="p-4 text-slate-500">${new Date().toLocaleDateString()}</td>
                <td class="p-4 font-bold">₹${amt}</td>
                <td class="p-4"><span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-bold">${status}</span></td>
                <td class="p-4 text-right"><button onclick="downloadReceipt('${desc}', '${amt}')" class="text-brand text-xs font-bold hover:underline">Receipt</button></td>
            `;
            tbody.appendChild(tr);
        }

        // ================= FUNCTIONAL LOGIC =================
        function updateGreeting() {
            const hour = new Date().getHours();
            const elem = document.getElementById('greetUser');
            if(elem) {
                let msg = "Good Morning";
                if(hour >= 12) msg = "Good Afternoon";
                if(hour >= 17) msg = "Good Evening";
                if(state.user) elem.innerText = `${msg}, ${state.user.name.split(' ')[0]}!`;
            }
        }

        function saveApplication(e) {
            e.preventDefault();
            if(state.application.paid) return;

            // Simulate Payment
            const btn = document.getElementById('btnSaveApp');
            const originalText = btn.innerText;
            btn.innerText = "Processing Payment...";
            
            setTimeout(() => {
                state.application.address = document.getElementById('app_address').value;
                state.application.city = document.getElementById('app_city').value;
                state.application.pincode = document.getElementById('app_pincode').value;
                state.application.paid = true;
                
                showToast('Payment Successful! Application Submitted.', 'success');
                saveState();
            }, 1500);
        }

        // --- FILE UPLOAD (BASE64) ---
        function handleFileUpload(key, input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Save Base64 string to state
                    state.documents[key] = e.target.result;
                    saveState();
                    showToast(`${key} document uploaded successfully!`, 'success');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- HOSTEL LOGIC ---
        let selectedHostelFee = 0;
        function updateHostelTotal(fee) {
            selectedHostelFee = fee;
            document.getElementById('hostelTotal').innerText = "₹" + fee.toLocaleString();
        }

        function payHostel() {
            if(selectedHostelFee === 0) return showToast('Please select a room type.', 'error');
            
            const btn = event.target;
            btn.innerText = "Processing...";
            
            setTimeout(() => {
                const type = document.querySelector('input[name="hostel"]:checked').value === 'NONAC' ? 'Non-AC' : 'AC';
                state.hostel.booked = true;
                state.hostel.type = type;
                state.hostel.fee = selectedHostelFee;
                
                saveState();
                showToast('Hostel Booked Successfully!', 'success');
                btn.innerText = "Book Now";
                updateUI();
            }, 1500);
        }

        // --- PDF DOWNLOADS ---
        function downloadReceipt(title, amount) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFillColor(238, 63, 54);
            doc.rect(0, 0, 210, 10, 'F');
            doc.setFontSize(22); doc.text("PPSU PAYMENT RECEIPT", 105, 30, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Student: ${state.user.name}`, 20, 50);
            doc.text(`ID: ${state.user.id}`, 20, 60);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, 50);
            
            doc.autoTable({
                startY: 70,
                head: [['Description', 'Amount', 'Status']],
                body: [[title, `INR ${amount}`, 'Success']],
            });
            
            doc.save(`${title}_Receipt.pdf`);
        }

        function downloadApplicationPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Application Summary 2026", 20, 20);
            doc.save("Application.pdf");
        }

        // --- TOAST NOTIFICATION SYSTEM ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
            
            const icon = type === 'success' ? '<i class="fa-solid fa-circle-check text-green-500 text-xl"></i>' : '<i class="fa-solid fa-circle-exclamation text-red-500 text-xl"></i>';
            
            toast.innerHTML = `${icon} <span class="font-medium text-slate-700 text-sm">${message}</span>`;
            
            container.appendChild(toast);
            
            // Trigger animation
            requestAnimationFrame(() => { toast.classList.add('show'); });

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Initialize App
        window.addEventListener('load', init);

    </script>
</body>
</html>