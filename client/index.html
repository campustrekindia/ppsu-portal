<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admission Portal 2026 - P P Savani University</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { ppsuRed: '#EE3F36', ppsuDark: '#030000', ppsuGray: '#f4f4f4' }, fontFamily: { sans: ['Roboto', 'sans-serif'] } }
            }
        }
    </script>
    
    <style>
        body { background-color: #f8fafc; font-family: 'Roboto', sans-serif; }
        .step-active { border-color: #EE3F36; color: #EE3F36; font-weight: bold; }
        .step-inactive { border-color: #e2e8f0; color: #94a3b8; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #EE3F36; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .nav-link { cursor: pointer; padding: 10px; display: block; color: #aaa; }
        .nav-link.active { color: white; background: rgba(255,255,255,0.1); border-right: 4px solid #EE3F36; }
        .preview-container { width: 100%; height: 100px; background-color: #f3f4f6; border: 2px dashed #d1d5db; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        .preview-img { width: 100%; height: 100%; object-fit: cover; display: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800">

    <header id="mainHeader" class="bg-white shadow-md sticky top-0 z-50 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="showHome()">
                <img src="https://www.ppsu.ac.in/img/PPSUNAACA+Logo.png" onerror="this.innerHTML='PPSU'" class="h-14 object-contain">
            </div>
            <div class="hidden md:flex items-center gap-6">
                <button onclick="showHome()" class="text-sm font-medium hover:text-ppsuRed">Home</button>
                <button onclick="showLoginScreen()" class="text-sm font-medium hover:text-ppsuRed">Student Login</button>
                <button onclick="showRegistration()" class="bg-ppsuRed text-white px-4 py-2 rounded-full text-sm font-bold shadow-sm hover:bg-red-700">Admissions 2026-27</button>
            </div>
        </div>
    </header>

    <main id="mainContainer" class="flex-grow flex items-center justify-center py-8 px-4">
        <div class="max-w-6xl w-full space-y-8">
            
            <div id="homeFlow" class="fade-in">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100 p-8 text-center">
                    <h1 class="text-4xl font-bold text-gray-900 mb-4">Welcome to <span class="text-ppsuRed">P P Savani University</span></h1>
                    <p class="text-gray-600 mb-8">Admissions Open for 2026-27</p>
                    <div class="flex justify-center gap-4">
                        <button onclick="showRegistration()" class="bg-ppsuRed text-white px-8 py-3 rounded-lg text-lg font-bold shadow-lg">Apply Now</button>
                        <button onclick="showLoginScreen()" class="bg-white text-gray-700 border border-gray-300 px-8 py-3 rounded-lg text-lg font-medium">Student Login</button>
                    </div>
                </div>
            </div>

            <div id="registrationFlow" class="hidden">
                <div class="flex justify-center items-center mb-8">
                    <div class="flex items-center w-full max-w-sm relative">
                        <div id="step1-indicator" class="flex flex-col items-center relative z-10"><div class="w-10 h-10 rounded-full border-2 bg-white flex items-center justify-center step-active">1</div><span class="text-xs mt-2 font-medium text-ppsuRed">Register</span></div>
                        <div class="flex-auto border-t-2 border-gray-200 absolute top-5 w-full left-0 z-0"></div>
                        <div id="step2-indicator" class="flex flex-col items-center ml-auto relative z-10"><div class="w-10 h-10 rounded-full border-2 bg-white flex items-center justify-center step-inactive">2</div><span class="text-xs mt-2 font-medium text-gray-400">Reg Fee</span></div>
                        <div id="step3-indicator" class="flex flex-col items-center ml-auto relative z-10"><div class="w-10 h-10 rounded-full border-2 bg-white flex items-center justify-center step-inactive">3</div><span class="text-xs mt-2 font-medium text-gray-400">Success</span></div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100">
                    <div class="bg-ppsuDark p-4 text-center"><h2 class="text-white text-xl font-bold uppercase">Admission Portal</h2></div>
                    
                    <div id="step1-content" class="p-8">
                        <form id="registrationForm" onsubmit="handleRegistration(event)">
                            <div class="space-y-5">
                                <input type="text" id="fullName" required placeholder="Full Name (As per Aadhaar)" class="block w-full px-3 py-2.5 border rounded-lg">
                                <input type="text" id="aadhaar" required placeholder="Aadhaar Number" maxlength="12" class="block w-full px-3 py-2.5 border rounded-lg">
                                <label class="text-xs text-gray-500">Date of Birth</label>
                                <input type="date" id="dob" required class="block w-full px-3 py-2.5 border rounded-lg">
                                <select id="course" required class="block w-full px-3 py-2.5 border rounded-lg bg-white">
                                    <option value="" disabled selected>Select Course...</option>
                                    <option value="B.Tech Computer Engineering">B.Tech Computer Engineering</option>
                                    <option value="B.Tech Civil Engineering">B.Tech Civil Engineering</option>
                                    <option value="MBA">MBA</option>
                                    <option value="BBA">BBA</option>
                                </select>
                                <input type="tel" id="mobile" required placeholder="Mobile Number" maxlength="10" class="block w-full px-3 py-2.5 border rounded-lg">
                                <input type="text" id="referral" required placeholder="Referral Name" class="block w-full px-3 py-2.5 border rounded-lg">
                                <button type="submit" class="w-full py-3 bg-ppsuRed text-white font-bold rounded-lg hover:bg-red-700">Proceed to Payment</button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="step2-content" class="hidden p-8 text-center">
                        <h3 class="text-xl font-bold mb-4">Confirm Registration</h3>
                        <div class="bg-slate-50 p-4 rounded mb-6 text-left">
                            <p>Name: <span id="summaryName" class="font-bold"></span></p>
                            <p>Course: <span id="summaryCourse" class="font-bold"></span></p>
                            <div class="flex justify-between items-center mt-4 border-t pt-4">
                                <span class="font-bold text-gray-600">Admission Fee</span>
                                <span class="text-2xl font-bold text-ppsuRed">₹12,500</span>
                            </div>
                        </div>
                        <button onclick="processAdmissionPayment()" class="w-full py-3 bg-green-600 text-white font-bold rounded-lg">Pay Securely Now</button>
                        <div id="paymentLoader" class="hidden mt-4"><div class="loader mx-auto"></div><p class="text-xs text-gray-500 mt-2">Processing Payment...</p></div>
                    </div>
                    
                    <div id="step3-content" class="hidden p-8 text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fa-solid fa-check text-3xl text-green-600"></i></div>
                        <h2 class="text-2xl font-bold mb-2">Registration Successful!</h2>
                        <div class="bg-blue-50 p-5 rounded-lg mb-6 text-left border border-blue-200">
                             <p class="text-sm">Username: <span id="credUsername" class="font-bold"></span></p>
                             <p class="text-sm">Password: <span id="credPassword" class="font-bold"></span></p>
                             <p class="text-xs text-gray-500 mt-2">App ID: <span id="credAppId"></span></p>
                        </div>
                        <button onclick="showLoginScreen()" class="w-full py-3 bg-ppsuRed text-white rounded-lg font-bold">Login to Dashboard</button>
                    </div>
                </div>
            </div>

            <div id="loginFlow" class="hidden">
                 <div class="max-w-md mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100">
                    <div class="bg-ppsuDark p-6 text-center text-white"><h2 class="text-xl font-bold">Student Login</h2></div>
                    <div class="p-8">
                        <form onsubmit="handleLogin(event)">
                            <div class="space-y-4">
                                <input type="tel" id="loginMobile" required placeholder="Mobile Number" class="block w-full px-3 py-2 border rounded-lg">
                                <input type="password" id="loginPass" required placeholder="Password (DOB: YYYY-MM-DD)" class="block w-full px-3 py-2 border rounded-lg">
                                <button type="submit" id="loginBtn" class="w-full py-3 bg-ppsuDark text-white rounded-lg font-bold">Login</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="dashboardFlow" class="hidden fixed inset-0 z-[60] bg-slate-50 flex overflow-hidden">
        <aside class="w-64 bg-ppsuDark text-white flex flex-col hidden md:flex h-full shadow-2xl">
            <div class="h-20 flex items-center gap-2 px-6 bg-black/30 border-b border-white/10"><i class="fa-solid fa-graduation-cap"></i><span class="font-bold">PPSU Portal</span></div>
            <div class="p-6 border-b border-white/10">
                <p id="sidebarName" class="font-bold truncate">Student</p>
                <p id="sidebarAppId" class="text-xs text-gray-400">APP0000</p>
            </div>
            <nav class="flex-1 py-4 space-y-1 overflow-y-auto">
                <a onclick="switchDashTab('home')" id="nav-home" class="nav-link active">Overview</a>
                <a onclick="switchDashTab('app')" id="nav-app" class="nav-link">My Application</a>
                <a onclick="switchDashTab('hostel')" id="nav-hostel" class="nav-link">Hostel Booking</a>
                <a onclick="switchDashTab('certs')" id="nav-certs" class="nav-link">Documents</a>
                <a onclick="switchDashTab('idcard')" id="nav-idcard" class="nav-link">Digital ID Card</a>
                <a onclick="switchDashTab('fees')" id="nav-fees" class="nav-link">Fee Structure</a>
                <a onclick="switchDashTab('receipts')" id="nav-receipts" class="nav-link">Receipts</a>
            </nav>
            <div class="p-4"><button onclick="logout()" class="w-full py-2 bg-red-600 rounded">Logout</button></div>
        </aside>

        <div class="flex-1 flex flex-col h-full overflow-hidden relative">
            <header class="bg-white shadow-sm h-16 flex items-center justify-between px-8 border-b">
                <h1 id="dashPageTitle" class="text-xl font-bold">Overview</h1>
                <span class="px-3 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full">Admitted</span>
            </header>

            <div class="flex-1 overflow-y-auto p-8 dashboard-scroll bg-slate-50">
                <div id="dash-home" class="max-w-5xl mx-auto fade-in">
                     <div class="bg-white rounded-xl p-6 shadow-sm border mb-6">
                        <h2 class="text-2xl font-bold">Welcome, <span id="dashNameHome" class="text-ppsuRed">Student</span>!</h2>
                        <p class="text-gray-500">Go to "My Application" to complete your profile.</p>
                     </div>
                </div>

                <div id="dash-app" class="max-w-4xl mx-auto hidden fade-in">
                    <form onsubmit="handleApplicationSubmit(event)" id="appFormDetails" class="bg-white rounded-xl shadow-sm border p-6">
                        <h3 class="font-bold mb-4">Update Details</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <input type="text" id="appFullName" readonly class="bg-gray-100 border p-2 rounded cursor-not-allowed">
                            <input type="text" id="appMobile" readonly class="bg-gray-100 border p-2 rounded cursor-not-allowed">
                            <input type="text" id="appCourse" readonly class="bg-gray-100 border p-2 rounded cursor-not-allowed">
                            <input type="email" id="appEmail" required placeholder="Email Address" class="border p-2 rounded">
                            <input type="text" id="appAddress" required placeholder="Address" class="border p-2 rounded col-span-2">
                            <input type="text" id="appCity" required placeholder="City" class="border p-2 rounded">
                            <input type="text" id="appState" required placeholder="State" class="border p-2 rounded">
                            <input type="text" id="appPincode" required placeholder="Pincode" class="border p-2 rounded">
                        </div>
                        <button type="submit" id="submitAppBtn" class="bg-ppsuDark text-white px-6 py-2 rounded">Save & Pay App Fee (₹1,200)</button>
                    </form>
                </div>

                <div id="dash-certs" class="max-w-6xl mx-auto hidden fade-in">
                    <h3 class="font-bold mb-2">Documents</h3>
                    <p class="text-sm text-red-500 mb-6">Note: Max file size 10 MB.</p>
                    <div class="grid grid-cols-3 gap-6">
                        <div class="bg-white p-4 rounded border text-center"><h4>10th Marksheet</h4><input type="file" id="file10th" class="text-xs my-2"><button onclick="uploadCert('10th Marksheet', 'btn10th')" id="btn10th" class="bg-black text-white px-4 py-1 rounded text-sm">Upload</button></div>
                        <div class="bg-white p-4 rounded border text-center"><h4>12th Marksheet</h4><input type="file" id="file12th" class="text-xs my-2"><button onclick="uploadCert('12th Marksheet', 'btn12th')" id="btn12th" class="bg-black text-white px-4 py-1 rounded text-sm">Upload</button></div>
                        <div class="bg-white p-4 rounded border text-center"><h4>TC</h4><input type="file" id="fileTC" class="text-xs my-2"><button onclick="uploadCert('TC', 'btnTC')" id="btnTC" class="bg-black text-white px-4 py-1 rounded text-sm">Upload</button></div>
                        <div class="bg-white p-4 rounded border text-center"><h4>Student Aadhaar</h4><input type="file" id="fileAadhaar" class="text-xs my-2"><button onclick="uploadCert('Student Aadhaar', 'btnAadhaar')" id="btnAadhaar" class="bg-black text-white px-4 py-1 rounded text-sm">Upload</button></div>
                        <div class="bg-white p-4 rounded border text-center"><h4>Father Aadhaar</h4><input type="file" id="fileFather" class="text-xs my-2"><button onclick="uploadCert('Father Aadhaar', 'btnFather')" id="btnFather" class="bg-black text-white px-4 py-1 rounded text-sm">Upload</button></div>
                        <div class="bg-white p-4 rounded border text-center"><h4>Mother Aadhaar</h4><input type="file" id="fileMother" class="text-xs my-2"><button onclick="uploadCert('Mother Aadhaar', 'btnMother')" id="btnMother" class="bg-black text-white px-4 py-1 rounded text-sm">Upload</button></div>
                    </div>
                </div>

                <div id="dash-hostel" class="hidden">
                    <h3 class="font-bold mb-4">Select Hostel</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div onclick="selectHostel('Non-AC', 75000)" class="bg-white p-6 border rounded cursor-pointer hover:shadow-lg"><h4>Non-AC</h4><p>₹75,000</p></div>
                        <div onclick="selectHostel('AC 3', 110000)" class="bg-white p-6 border rounded cursor-pointer hover:shadow-lg"><h4>AC 3 Sharing</h4><p>₹1,10,000</p></div>
                        <div onclick="selectHostel('AC 2', 140000)" class="bg-white p-6 border rounded cursor-pointer hover:shadow-lg"><h4>AC 2 Sharing</h4><p>₹1,40,000</p></div>
                    </div>
                </div>
                
                <div id="dash-idcard" class="hidden flex justify-center"><div class="w-80 bg-white border rounded shadow p-4 text-center"><h2 class="font-bold">Student ID</h2><p id="idCardName">Student</p><p id="idCardNo">ID: --</p></div></div>
                
                <div id="dash-fees" class="hidden"><h3 class="font-bold">Fee Structure</h3><p>Total: ₹3,80,000</p></div>
                <div id="dash-receipts" class="hidden">
                    <h3 class="font-bold mb-4">Receipts</h3>
                    <div class="bg-white p-4 border rounded flex justify-between mb-2"><span>Admission Fee (₹12,500)</span><span class="text-green-600 font-bold">PAID</span></div>
                    <div id="recAppFee" class="bg-white p-4 border rounded flex justify-between hidden"><span>Application Fee (₹1,200)</span><span class="text-green-600 font-bold">PAID</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="appPayModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center">
        <div class="bg-white rounded p-8 text-center">
            <h3 class="text-xl font-bold">Application Fee</h3>
            <p class="text-2xl text-ppsuRed my-4">₹1,200</p>
            <button onclick="confirmAppPayment()" class="bg-green-600 text-white px-6 py-2 rounded">Pay Now</button>
        </div>
    </div>

    <script>
        let currentUser = null;
        const API = "https://ppsu-backend.onrender.com/api";
        const getEl = (id) => document.getElementById(id);
        const show = (id) => getEl(id).classList.remove('hidden');
        const hide = (id) => getEl(id).classList.add('hidden');

        // REGISTER (Basic Info)
        async function handleRegistration(e) {
            e.preventDefault();
            const data = {
                fullName: getEl('fullName').value, aadhaar: getEl('aadhaar').value, dob: getEl('dob').value,
                course: getEl('course').value, mobile: getEl('mobile').value, referral: getEl('referral').value,
                applicationId: '2026' + Math.floor(100000 + Math.random() * 900000)
            };
            try {
                const res = await fetch(`${API}/register`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                if(res.ok) {
                    currentUser = data; 
                    getEl('summaryName').innerText = data.fullName;
                    getEl('summaryCourse').innerText = data.course;
                    hide('step1-content'); show('step2-content'); // Show Fee Payment
                    getEl('step1-indicator').className = "w-10 h-10 rounded-full border-2 bg-white flex items-center justify-center step-inactive";
                    getEl('step2-indicator').className = "w-10 h-10 rounded-full border-2 bg-white flex items-center justify-center step-active";
                } else alert("Registration Failed");
            } catch(e) { alert("Server Error"); }
        }

        // PAY ADMISSION FEE (12,500) - Updates Backend
        async function processAdmissionPayment() {
            show('paymentLoader');
            await fetch(`${API}/update-application`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ applicationId: currentUser.applicationId, regFeeStatus: "Paid" }) 
            });
            setTimeout(() => {
                hide('paymentLoader'); hide('step2-content'); show('step3-content'); // Show Success
                getEl('credUsername').innerText = currentUser.mobile;
                getEl('credPassword').innerText = currentUser.dob;
                getEl('step2-indicator').className = "w-10 h-10 rounded-full border-2 bg-white flex items-center justify-center step-inactive";
                getEl('step3-indicator').className = "w-10 h-10 rounded-full border-2 bg-white flex items-center justify-center step-active";
            }, 2000);
        }

        // LOGIN (Checks if Fee is Paid)
        async function handleLogin(e) {
            e.preventDefault();
            const btn = getEl('loginBtn'); btn.innerText = "Checking...";
            const mobile = getEl('loginMobile').value;
            const dob = getEl('loginPass').value;

            try {
                const res = await fetch(`${API}/login`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({mobile, dob}) });
                const data = await res.json();
                if(res.ok) {
                    currentUser = data.student;
                    loadDashboard(currentUser);
                    hide('loginFlow'); show('dashboardFlow');
                } else {
                    alert(data.error); // E.g. "Fee not paid"
                }
            } catch(e) { alert("Login Error"); }
            finally { btn.innerText = "Login"; }
        }

        function loadDashboard(user) {
            getEl('sidebarName').innerText = user.fullName;
            getEl('sidebarAppId').innerText = user.applicationId;
            getEl('dashNameHome').innerText = user.fullName;
            getEl('idCardName').innerText = user.fullName;
            getEl('idCardNo').innerText = user.applicationId;
            getEl('idCardCourseDisplay').innerText = user.course;

            getEl('appFullName').value = user.fullName;
            getEl('appMobile').value = user.mobile;
            getEl('appCourse').value = user.course;
            getEl('appEmail').value = user.email || "";
            getEl('appAddress').value = user.address || "";
            getEl('appCity').value = user.city || "";
            getEl('appState').value = user.state || "";
            getEl('appPincode').value = user.pincode || "";
            
            if(user.appFeeStatus === "Paid") {
                getEl('submitAppBtn').innerText = "Details Saved & Fee Paid";
                getEl('submitAppBtn').disabled = true;
                getEl('submitAppBtn').classList.add('opacity-50');
                show('recAppFee');
            }
        }

        // SUBMIT APP & PAY (1,200)
        async function handleApplicationSubmit(e) {
            e.preventDefault();
            const updateData = {
                applicationId: currentUser.applicationId,
                email: getEl('appEmail').value, address: getEl('appAddress').value,
                city: getEl('appCity').value, state: getEl('appState').value, pincode: getEl('appPincode').value
            };
            // Save address first
            await fetch(`${API}/update-application`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(updateData) });
            // Trigger Payment Modal
            show('appPayModal');
        }

        async function confirmAppPayment() {
            hide('appPayModal');
            // Mark App Fee Paid
            await fetch(`${API}/update-application`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ applicationId: currentUser.applicationId, appFeeStatus: "Paid" }) 
            });
            alert("Fee Paid!");
            currentUser.appFeeStatus = "Paid";
            loadDashboard(currentUser);
        }

        // UPLOAD (Fixed Name Logic)
        async function uploadCert(docType, btnId) {
            if(!currentUser) return alert("Please Login First");
            const fileInput = getEl(btnId.replace('btn', 'file'));
            if(!fileInput.files[0]) return alert("Select File");

            const btn = getEl(btnId); btn.innerText = "...";
            const fd = new FormData();
            fd.append("file", fileInput.files[0]);
            fd.append("studentName", currentUser.fullName);
            fd.append("docType", docType);

            try {
                const res = await fetch(`${API}/upload`, { method: 'POST', body: fd });
                if(res.ok) { alert("Uploaded!"); btn.innerText = "Done"; }
                else alert("Upload Failed");
            } catch(e) { alert("Error"); }
        }

        // NAV
        function showHome() { hide('registrationFlow'); hide('loginFlow'); hide('dashboardFlow'); show('homeFlow'); }
        function showRegistration() { hide('homeFlow'); hide('loginFlow'); show('registrationFlow'); }
        function showLoginScreen() { hide('homeFlow'); hide('registrationFlow'); show('loginFlow'); }
        function logout() { location.reload(); }
        function switchDashTab(tab) {
            ['home','app','hostel','certs','idcard','fees','receipts'].forEach(t => hide('dash-'+t));
            show('dash-'+tab);
        }
        function selectHostel(t, p) { alert(`Selected ${t}. Proceed to Pay.`); }
    </script>
</body>
</html>